name: CI

on:
  push:
  pull_request:
  repository_dispatch:
    types: [run_build]

jobs:

  build:
    runs-on: ${{ matrix.os[0] }}
    strategy:
      matrix:
        os: [
          [macos-latest, arm64, bash],
          [macos-13, x86_64, bash],
          [ubuntu-latest, x86_64, bash],
        ]
      fail-fast: false
    defaults:
     run:
      shell: ${{ matrix.os[2] }} {0}

    steps:
    - uses: actions/checkout@v4
    
    - name : Install dependencies on required OS
      run: | 
        ./prepare.sh

    - name : Build Project
      run: | 
        ./build_daedalus.sh
    - name: Prepare artifacts
      run: |
        tar -zcvf DaedalusX64-${{matrix.os[0]}}-${{matrix.os[1]}}.tar.gz \
          DaedalusX64/daedalus \
          DaedalusX64/n64.psh \
          DaedalusX64/roms.ini \
          DaedalusX64/readme.txt \
          DaedalusX64/copying.txt \
          DaedalusX64/Resources \
          DaedalusX64/Languages \
          DaedalusX64/ControllerConfigs \

    - uses: actions/upload-artifact@v4
      with:
        name: DaedalusX64-${{matrix.os[0]}}-${{matrix.os[1]}}
        path: DaedalusX64-${{matrix.os[0]}}-${{matrix.os[1]}}.tar.gz

    - name: Create pre-release
      if: ${{ github.ref == 'refs/heads/master' }}
      uses: softprops/action-gh-release@v2
      with: 
        files: DaedalusX64-${{matrix.os[0]}}-${{matrix.os[1]}}.tar.gz
        prerelease: true
        tag_name: latest"
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release
      if: ${{ github.ref_type == 'tag' }}
      uses: softprops/action-gh-release@v2
      with:
        files: DaedalusX64-${{matrix.os[0]}}-${{matrix.os[1]}}.tar.gz
        tag_name: latest"
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-psp:
    name: PSP Build
    runs-on: ubuntu-latest
    container: pspdev/pspdev:latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apk add build-base git bash cmake
    
    - name: Compile project
      run: |
        ./build_daedalus.sh PSP

    - name: Get short SHA
      id: slug
      run: echo "{name}={sha8::$(echo ${GITHUB_SHA} | cut -c1-8)}" >> $GITHUB_OUTPUT

    - name: Prepare artifacts
      run: |
        tar -zcvf daedalusX64-PSP.tar.gz \
          DaedalusX64/Plugins \
          DaedalusX64/EBOOT.PBP \
          DaedalusX64/roms.ini \
          DaedalusX64/readme.txt \
          DaedalusX64/copying.txt \
          DaedalusX64/Resources \
          DaedalusX64/Languages \
          DaedalusX64/ControllerConfigs \


    - name: Upload artifacts
      if: ${{ success() }}
      uses: actions/upload-artifact@v4
      with:
        name: DaedalusX64-PSP
        path: daedalusX64-PSP.tar.gz

    - name: Extract tag name
      if: startsWith(github.ref, 'refs/tags/')
      id: tag
      run: echo "{name}={VERSION::${GITHUB_REF/refs\/tags\//}}" >> $GITHUB_OUTPUT

  build-ctr:
    runs-on: ubuntu-latest
    container: devkitpro/devkitarm:latest
    steps:
      - uses: actions/checkout@v4 

      - name: Compile project
        run: | 
          ./prepare.sh
          ./build_daedalus.sh CTR

      - name: Prepare artifacts
        run: |
          tar -zcvf daedalusX64-CTR.tar.gz DaedalusX64\

      - name: Upload artifacts
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: daedalusX64-CTR
          path: daedalusX64-CTR.tar.gz

  build-windows:
      runs-on: windows-latest
      env:
        VCPKG_DEFAULT_TRIPLET: x64-windows
      steps:
        - uses: actions/checkout@v4

        - uses: lukka/get-cmake@latest

        - name: Setup a new (or from cache) vcpkg
          uses: lukka/run-vcpkg@v11
          with:
            vcpkgGitCommitId: aa628ceb5f15f0c30d4d481f14fa5b2be2b4a658
            runVcpkgInstall: true

        - name: Run CMake config
          run: |
            cmake -S . -B build "-DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake" "-DVCPKG_TARGET_TRIPLET=x64-windows"
    
        - name: Build
          run: |
            cmake --build build --config Release

        - name: Prepare artifacts
          run: |
              tar -zcvf daedalusX64-Win-$(arch).tar.gz DaedalusX64\
    
        - name: Upload artifacts
          if: ${{ success() }}
          uses: actions/upload-artifact@v4
          with:
            name: daedalusX64-WIN
            path: daedalusX64-WIN-$(arch).tar.gz
  
